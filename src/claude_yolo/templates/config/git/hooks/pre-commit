#!/bin/bash
# Git pre-commit hook for safety checks

# Check for secrets with gitleaks
if command -v gitleaks &> /dev/null; then
    if ! gitleaks protect --staged --redact --verbose 2>&1; then
        echo "❌ SECURITY: Potential secrets detected in commit!"
        exit 1
    fi
fi

# Check for large files
MAX_SIZE=1000  # KB
while IFS= read -r file; do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
        size_kb=$((size / 1024))
        if [ $size_kb -gt $MAX_SIZE ]; then
            echo "❌ SAFETY: Large file detected: $file (${size_kb}KB)"
            echo "   Files over ${MAX_SIZE}KB should not be committed"
            exit 1
        fi
    fi
done < <(git diff --cached --name-only --diff-filter=ACM)

# Check for common sensitive file patterns
# Exclude .env.example (template file, no real secrets)
SENSITIVE_PATTERNS=(
    "\.env$"
    "\.env\.local"
    "\.env\.production"
    "\.env\.development"
    "credentials\.json"
    "\.aws/credentials"
    "\.ssh/id_rsa"
    "\.pem$"
    "\.key$"
    "\.p12$"
    "\.pfx$"
    "secret"
    "\.crt$"
)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if git diff --cached --name-only | grep -qE "$pattern"; then
        matching_files=$(git diff --cached --name-only | grep -E "$pattern")
        echo "⚠️  WARNING: Potentially sensitive files detected:"
        echo "$matching_files"
        echo ""
        echo "Are you sure you want to commit these files? (yes/no)"
        read -r response
        if [[ ! "$response" =~ ^[Yy][Ee][Ss]$ ]]; then
            exit 1
        fi
    fi
done

exit 0

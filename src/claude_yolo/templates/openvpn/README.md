# OpenVPN Client Integration

Connect your Claude YOLO container to your corporate VPN automatically on startup. Perfect for accessing internal APIs, databases, and services that require VPN access.

## Quick Start

### 1. Get Your OpenVPN Config File

Get your `.ovpn` configuration file from your VPN administrator or download it from your company's VPN portal.

Common VPN providers:
- **Corporate VPN**: Usually provided by IT department
- **Managed VPN services**: Download from portal
- **Self-hosted**: Generated by your OpenVPN server

### 2. Place Config in This Directory

```bash
# Copy your .ovpn file to this directory
cp ~/Downloads/company-vpn.ovpn ./openvpn/

# Or create a symlink
ln -s ~/path/to/your.ovpn ./openvpn/client.ovpn
```

### 3. Configure Environment

Edit `.env` in the project root:

```bash
# Required: Name of your .ovpn file
OPENVPN_CONFIG=company-vpn.ovpn

# Optional: If your VPN uses username/password authentication
OPENVPN_AUTH_USER=your-username
OPENVPN_AUTH_PASS=your-password
```

**Security Note:** The `.env` file is already in `.gitignore`. Never commit VPN credentials!

### 4. Start the Container

```bash
# OpenVPN starts automatically when OPENVPN_CONFIG is set
docker-compose up -d

# Check VPN status
make openvpn-status

# View VPN logs
make openvpn-logs
```

## Authentication Methods

### Certificate-Based Authentication (Recommended)

Most secure method. Your `.ovpn` file contains embedded certificates:

```bash
# Just set the config file
OPENVPN_CONFIG=client.ovpn

# No username/password needed
```

### Username/Password Authentication

If your VPN requires credentials:

```bash
OPENVPN_CONFIG=client.ovpn
OPENVPN_AUTH_USER=your-username
OPENVPN_AUTH_PASS=your-password
```

### Combined (Certificate + Password)

Some VPNs require both:

```bash
OPENVPN_CONFIG=client.ovpn
OPENVPN_AUTH_USER=your-username
OPENVPN_AUTH_PASS=your-password
```

## Configuration File Format

Your `.ovpn` file should look something like this:

```
client
dev tun
proto udp
remote vpn.company.com 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
cert client.crt
key client.key
comp-lzo
verb 3
```

### Inline Certificates

Many modern VPN configs include certificates inline:

```
client
dev tun
proto udp
remote vpn.company.com 1194
...
<ca>
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
</ca>
<cert>
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
</cert>
<key>
-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----
</key>
```

This is preferred - everything is in one file!

## Verification

### Check VPN Connection

```bash
# Method 1: Use make target
make openvpn-status

# Method 2: Check directly
docker exec claude-yolo ip addr show tun0

# Method 3: Check routing
docker exec claude-yolo ip route
```

### Test Internal Access

```bash
# SSH into container
docker exec -it claude-yolo bash

# Try accessing internal resource
curl https://internal-api.company.com/health

# Check DNS resolution
nslookup internal-server.company.local
```

### View Logs

```bash
# Real-time logs
make openvpn-logs

# Or directly
tail -f logs/openvpn.log
```

## Common Issues

### Connection Fails Immediately

**Symptoms:** Container starts but VPN doesn't connect

**Diagnosis:**
```bash
# Check logs for errors
tail -f logs/openvpn.log

# Common errors:
# - "Auth Failed" → Wrong username/password
# - "Connection timeout" → Firewall/network issue
# - "TLS error" → Certificate problem
```

**Solutions:**
1. Verify `.ovpn` file is correct
2. Check username/password (if used)
3. Ensure your host can reach VPN server
4. Try from host first: `openvpn --config openvpn/your-file.ovpn`

### DNS Not Working Inside VPN

**Symptoms:** Can ping internal IPs but not hostnames

**Solution:**
Check if your `.ovpn` includes DNS settings:

```
# Add to .ovpn file if missing
dhcp-option DNS 10.0.0.1
dhcp-option DOMAIN company.local
```

### Split Tunnel vs Full Tunnel

**Full Tunnel** (all traffic through VPN):
```
# Usually default - routes everything through VPN
redirect-gateway def1
```

**Split Tunnel** (only internal traffic through VPN):
```
# Comment out or remove:
# redirect-gateway def1

# VPN server pushes specific routes
```

### Permission Denied Errors

**Symptoms:** OpenVPN fails with permission errors

**Diagnosis:**
```bash
# Check file permissions
ls -l openvpn/
```

**Solution:**
```bash
# Fix permissions
chmod 600 openvpn/*.ovpn
chmod 600 openvpn/*.key  # if separate key files
```

### "TUN/TAP device not available"

**Symptoms:** Error about `/dev/net/tun` not found

**Solution:**
This should be handled by `docker-compose.yml`, but verify:

```yaml
devices:
  - /dev/net/tun:/dev/net/tun
cap_add:
  - NET_ADMIN
```

If still failing, check host system:
```bash
# On host
ls -l /dev/net/tun

# If missing, create it
sudo mkdir -p /dev/net
sudo mknod /dev/net/tun c 10 200
sudo chmod 0666 /dev/net/tun
```

## Use Cases

### 1. Corporate Development

Access company resources while developing:

```bash
# Container auto-connects to corporate VPN on startup
docker-compose up -d

# Claude Code can now access:
# - Internal APIs
# - Private databases
# - Corporate git repos
# - Internal documentation
```

### 2. Multi-Region Development

Connect to different regional VPNs:

```bash
# .env for US region
OPENVPN_CONFIG=us-east.ovpn

# Switch to EU region
OPENVPN_CONFIG=eu-west.ovpn
docker-compose restart
```

### 3. Client Site Work

Connect to client's VPN for project work:

```bash
# Keep multiple configs
openvpn/
  ├── client-a.ovpn
  ├── client-b.ovpn
  └── client-c.ovpn

# Switch in .env as needed
OPENVPN_CONFIG=client-a.ovpn
```

### 4. Testing Behind Corporate Firewall

Test how your app behaves within corporate network:

```bash
# Connect to VPN
OPENVPN_CONFIG=company.ovpn

# Run your app on port 8000
# Test against internal services
# Verify firewall rules
```

## Advanced Configuration

### Custom DNS Settings

Override DNS from VPN config:

```bash
# Add to .ovpn file
script-security 2
up /etc/openvpn/update-resolv-conf
down /etc/openvpn/update-resolv-conf
```

### Compression

Enable compression for slower connections:

```
# In .ovpn file
comp-lzo yes
# Or modern alternative:
compress lz4-v2
```

### Keep-Alive

Maintain connection through NAT/firewalls:

```
# In .ovpn file
keepalive 10 120
```

### Multiple VPN Configs

Run multiple containers with different VPNs:

```bash
# Instance 1
OPENVPN_CONFIG=vpn-1.ovpn
CONTAINER_NAME=claude-yolo-vpn1

# Instance 2
OPENVPN_CONFIG=vpn-2.ovpn
CONTAINER_NAME=claude-yolo-vpn2
```

## Security Best Practices

### Config File Security

✅ **DO:**
- Store `.ovpn` files only in this directory (ignored by git)
- Use certificate-based auth when possible
- Set restrictive permissions: `chmod 600 *.ovpn`
- Use separate auth files for passwords (not in .ovpn)
- Review VPN logs regularly

❌ **DON'T:**
- Commit `.ovpn` files to git
- Share VPN credentials in chat/email
- Use same VPN config for multiple people
- Leave passwords in plain text in `.env` (consider env-file instead)

### Credentials Management

**Option 1: Environment Variables** (quick but less secure)
```bash
OPENVPN_AUTH_USER=user
OPENVPN_AUTH_PASS=pass
```

**Option 2: Docker Secrets** (more secure)
```yaml
secrets:
  vpn_user:
    file: ./secrets/vpn_user.txt
  vpn_pass:
    file: ./secrets/vpn_pass.txt
```

**Option 3: External Secrets Manager** (enterprise)
```bash
# Fetch from vault/secrets manager
export OPENVPN_AUTH_PASS=$(vault read -field=password secret/vpn)
```

### Network Isolation

Consider network policies:

```yaml
# Restrict outbound traffic
networks:
  vpn-only:
    internal: true
```

## Combining with Tailscale

You can run both Tailscale and OpenVPN simultaneously:

```bash
# Corporate VPN for internal resources
OPENVPN_CONFIG=corporate.ovpn

# Tailscale for remote access to container
TS_AUTHKEY=tskey-auth-xxxxx

# Both start automatically!
docker-compose up -d
```

**Use case:** Access container remotely via Tailscale while it's connected to corporate VPN.

## Disabling OpenVPN

```bash
# Option 1: Comment out in .env
# OPENVPN_CONFIG=client.ovpn
docker-compose restart

# Option 2: Stop manually
docker exec claude-yolo sudo pkill openvpn

# Option 3: Stop container entirely
docker-compose down
```

## Troubleshooting Commands

```bash
# Check if VPN process is running
docker exec claude-yolo ps aux | grep openvpn

# View full OpenVPN logs
docker exec claude-yolo cat /logs/openvpn.log

# Test connectivity through VPN
docker exec claude-yolo curl -v https://internal.company.com

# Check routing table
docker exec claude-yolo ip route show

# Check DNS resolution
docker exec claude-yolo nslookup internal.company.local

# Restart VPN without restarting container
docker exec claude-yolo sudo pkill openvpn
docker-compose restart
```

## Additional Resources

- [OpenVPN Documentation](https://openvpn.net/community-resources/)
- [OpenVPN Configuration Reference](https://openvpn.net/community-resources/reference-manual-for-openvpn-2-6/)
- [Docker OpenVPN Guide](https://github.com/kylemanna/docker-openvpn)

## FAQ

**Q: Can I use multiple VPN configs?**
A: Not simultaneously in one container. Use multiple container instances or switch configs via `.env`.

**Q: Does this work with WireGuard?**
A: This is for OpenVPN only. WireGuard support could be added separately (similar approach).

**Q: Will this slow down my container?**
A: Only traffic routed through VPN is affected. Impact depends on VPN server speed and location.

**Q: Can I use this with free VPN services?**
A: Technically yes, but this is designed for corporate/work VPNs. Free VPN configs work the same way.

**Q: What if my VPN uses 2FA?**
A: Most corporate VPNs with 2FA use certificate-based auth after initial setup. Check with your VPN admin.

**Q: How do I know if my traffic is going through VPN?**
A: Check your external IP inside container: `docker exec claude-yolo curl ifconfig.me` - should show VPN exit IP.
